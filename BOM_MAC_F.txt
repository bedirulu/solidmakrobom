' ╔════════════════════════════════════════════════════════════════╗
' ║  SolidWorks BOM Export Macro — v2.0 Final                    ║
' ║                                                              ║
' ║  Montaj parcalarini resimli olarak Excel'e aktarir.          ║
' ║                                                              ║
' ║  Sutunlar:                                                   ║
' ║  Resim | Sira No | Parca Adi | Konfigurasyon | Malzeme       ║
' ║        | Miktar  | Birim Agirlik (kg) | Net Agirlik (kg)     ║
' ╚════════════════════════════════════════════════════════════════╝
'
'  KURULUM:
'  ────────────────────────────────────────────────────────────────
'  1. SolidWorks'te VBA Editor'u acin  →  Alt + F11
'
'  2. MODUL EKLE:
'     Insert > Module
'     Asagidaki "══ MODULE KODU BASLANGIC ══" ile
'     "══ MODULE KODU BITIS ══" arasindaki kodu yapistirin.
'
'  3. CLASS MODULE EKLE:
'     Insert > Class Module
'     Properties penceresinden Name = "CBomRow" yapin
'     Asagidaki "══ CLASS KODU BASLANGIC ══" ile
'     "══ CLASS KODU BITIS ══" arasindaki kodu yapistirin.
'
'  4. Bir montaj dosyasi (.SLDASM) acin ve makroyu calistirin.
'  ────────────────────────────────────────────────────────────────
'
'  OZELLIKLER:
'  - FeatureManager agac sirasi korunur
'  - Ayni parca+konfig otomatik gruplanir (miktar artar)
'  - Alt montajlar icine inilir, sadece parcalar listelenir
'  - Model kapali parcalar listelenir → agirlik/resim "?" olur
'  - Agirlik 2 ondalik hassasiyetle gosterilir
'  - Resimler SolidWorks preview'dan alinir
'  - Resimler hucreye civilenir (Placement = xlMoveAndSizeWithCells)
'  - Her resim oncesi satira scroll yapilir (kayma onlenir)
'


' ══════════════════════════════════════════════════════════════════
' ══  MODULE KODU BASLANGIC                                     ══
' ══  (Insert > Module icine yapistirin)                        ══
' ══════════════════════════════════════════════════════════════════

Option Explicit

Dim gRows As Collection

' ─────────────────────────────────────────────
'  ANA MAKRO
' ─────────────────────────────────────────────
Sub ExportBomToExcel()

    Dim swApp     As Object
    Dim swModel   As Object
    Dim finalRows As Collection

    Set swApp   = Application.SldWorks
    Set swModel = swApp.ActiveDoc

    If swModel Is Nothing Then
        MsgBox "Acik bir dokuman bulunamadi!", vbExclamation, "Parca Listesi"
        Exit Sub
    End If

    If swModel.GetType <> 2 Then
        MsgBox "Lutfen bir montaj dosyasi (.SLDASM) acin.", vbExclamation, "Parca Listesi"
        Exit Sub
    End If

    Set gRows = New Collection
    TraverseModel swModel

    If gRows.Count = 0 Then
        MsgBox "Listelenecek parca bulunamadi.", vbInformation, "Parca Listesi"
        Exit Sub
    End If

    Set finalRows = GroupRows(gRows)
    WriteToExcel finalRows, swApp

    MsgBox finalRows.Count & " parca eklendi.", _
           vbInformation, "Parca Listesi"

End Sub

' ─────────────────────────────────────────────
'  MONTAJ AGACI DOLASMA
' ─────────────────────────────────────────────
Private Sub TraverseModel(swModel As Object)

    Dim swFeat As Object, nxt As Object
    Dim ft     As String

    If swModel Is Nothing Then Exit Sub

    On Error Resume Next
    Set swFeat = swModel.FirstFeature
    On Error GoTo 0

    Do While Not swFeat Is Nothing
        ft = ""
        On Error Resume Next: ft = swFeat.GetTypeName2: On Error GoTo 0

        If ft = "Reference" Or ft = "ReferencePattern" Then ProcessFeat swFeat

        Set nxt = Nothing
        On Error Resume Next: Set nxt = swFeat.GetNextFeature: On Error GoTo 0
        Set swFeat = nxt
    Loop

End Sub

Private Sub TraverseComp(swComp As Object)

    Dim swFeat As Object, nxt As Object
    Dim ft     As String

    If swComp Is Nothing Then Exit Sub

    On Error Resume Next
    Set swFeat = swComp.FirstFeature
    On Error GoTo 0

    Do While Not swFeat Is Nothing
        ft = ""
        On Error Resume Next: ft = swFeat.GetTypeName2: On Error GoTo 0

        If ft = "Reference" Or ft = "ReferencePattern" Then ProcessFeat swFeat

        Set nxt = Nothing
        On Error Resume Next: Set nxt = swFeat.GetNextFeature: On Error GoTo 0
        Set swFeat = nxt
    Loop

End Sub

' ─────────────────────────────────────────────
'  FEATURE ISLEME
' ─────────────────────────────────────────────
Private Sub ProcessFeat(swFeat As Object)

    Dim swComp      As Object
    Dim swCompModel As Object
    Dim rawPath     As String
    Dim cfg         As String
    Dim isSup       As Boolean
    Dim isExcl      As Boolean
    Dim compType    As Integer
    Dim row         As CBomRow

    If swFeat Is Nothing Then Exit Sub

    Set swComp = Nothing
    On Error Resume Next: Set swComp = swFeat.GetSpecificFeature2: On Error GoTo 0
    If swComp Is Nothing Then Exit Sub

    ' Bastirilmis veya BOM-disinda ise atla
    isSup = False: isExcl = False
    On Error Resume Next
    isSup = swComp.IsSuppressed
    isExcl = swComp.ExcludeFromBOM
    On Error GoTo 0
    If isSup Or isExcl Then Exit Sub

    ' Dosya yolu
    rawPath = ""
    On Error Resume Next: rawPath = Trim(swComp.GetPathName): On Error GoTo 0
    If rawPath = "" Then Exit Sub

    ' Konfigurasyon
    cfg = ""
    On Error Resume Next: cfg = Trim(swComp.ReferencedConfiguration): On Error GoTo 0
    If cfg = "" Then cfg = "Default"

    ' Model referansi
    Set swCompModel = Nothing
    On Error Resume Next: Set swCompModel = swComp.GetModelDoc2: On Error GoTo 0

    ' Komponent tipi belirle
    compType = 0
    If Not swCompModel Is Nothing Then
        On Error Resume Next: compType = swCompModel.GetType: On Error GoTo 0
    End If
    If compType = 0 Then
        If LCase(Right(rawPath, 7)) = ".sldprt" Then compType = 1
        If LCase(Right(rawPath, 7)) = ".sldasm" Then compType = 2
    End If

    Select Case compType
        Case 1  ' Parca → listeye ekle
            Set row = New CBomRow
            row.parcaAdi  = FileNameNoExt(rawPath)
            row.konfig    = cfg
            row.dosyaYolu = rawPath
            row.miktar    = 1
            row.key       = LCase(rawPath) & "::" & LCase(cfg)
            row.modelAcik = Not (swCompModel Is Nothing)
            row.agirlik   = GetMassKg(swCompModel)
            row.malzeme   = GetMalzeme(swCompModel)
            gRows.Add row

        Case 2  ' Alt montaj → icine in
            TraverseComp swComp
    End Select

End Sub

' ─────────────────────────────────────────────
'  GRUPLAMA (ayni parca + konfig → miktar artar)
' ─────────────────────────────────────────────
Private Function GroupRows(src As Collection) As Collection

    Dim result  As Collection
    Dim dict    As Object
    Dim i       As Integer
    Dim r       As CBomRow
    Dim ex      As CBomRow

    Set result = New Collection
    Set dict   = CreateObject("Scripting.Dictionary")

    For i = 1 To src.Count
        Set r = src(i)
        If dict.Exists(r.key) Then
            Set ex = result(dict(r.key))
            ex.miktar = ex.miktar + 1
        Else
            result.Add r
            dict.Add r.key, result.Count
        End If
    Next i

    Set GroupRows = result

End Function

' ─────────────────────────────────────────────
'  AGIRLIK (kg)
' ─────────────────────────────────────────────
Private Function GetMassKg(swModel As Object) As Double

    Dim mp As Object

    GetMassKg = 0
    If swModel Is Nothing Then Exit Function

    On Error GoTo ErrOut
    Set mp = swModel.Extension.CreateMassProperty
    If mp Is Nothing Then Exit Function
    mp.UseSystemUnits = True
    If mp.Mass > 0 Then GetMassKg = mp.Mass
    Exit Function
ErrOut:
    GetMassKg = 0

End Function

' ─────────────────────────────────────────────
'  MALZEME
' ─────────────────────────────────────────────
Private Function GetMalzeme(swModel As Object) As String

    Dim matName As String, matDB As String
    Dim cp      As Object
    Dim vO      As String, vR As String, ok As Boolean
    Dim cfgN    As String

    GetMalzeme = "-"
    If swModel Is Nothing Then Exit Function

    ' Yontem 1: Dogrudan malzeme adi
    On Error Resume Next
    matName = swModel.GetMaterialPropertyName2("", matDB)
    On Error GoTo 0
    If matName <> "" And matName <> "Material not specified" Then
        GetMalzeme = matName: Exit Function
    End If

    ' Yontem 2: Genel ozel ozellikler
    On Error Resume Next
    Set cp = swModel.Extension.CustomPropertyManager("")
    If Not cp Is Nothing Then
        ok = cp.Get5("Material", False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Matiere",  False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Malzeme",  False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Materiau", False, vO, vR, False)
        If vR <> "" Then GetMalzeme = vR: On Error GoTo 0: Exit Function
    End If
    On Error GoTo 0

    ' Yontem 3: Konfigurasyon ozel ozellikleri
    On Error Resume Next
    cfgN = swModel.GetActiveConfiguration().Name
    Set cp = swModel.Extension.CustomPropertyManager(cfgN)
    If Not cp Is Nothing Then
        ok = cp.Get5("Material", False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Matiere",  False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Malzeme",  False, vO, vR, False)
        If vR = "" Then ok = cp.Get5("Materiau", False, vO, vR, False)
        If vR <> "" Then GetMalzeme = vR
    End If
    On Error GoTo 0

End Function

' ─────────────────────────────────────────────
'  DOSYA ADI (uzantisiz)
' ─────────────────────────────────────────────
Private Function FileNameNoExt(fullPath As String) As String

    Dim s As Integer, d As Integer, nm As String

    If Trim(fullPath) = "" Then FileNameNoExt = "Bilinmiyor": Exit Function

    On Error GoTo ErrOut
    s  = InStrRev(fullPath, "\")
    nm = IIf(s > 0, Mid(fullPath, s + 1), fullPath)
    d  = InStrRev(nm, ".")
    FileNameNoExt = IIf(d > 0, Left(nm, d - 1), nm)
    Exit Function
ErrOut:
    FileNameNoExt = "Bilinmiyor"

End Function

' ─────────────────────────────────────────────
'  BOS BEYAZ BMP OLUSTUR (resim alinamazsa)
' ─────────────────────────────────────────────
Private Sub CreateWhiteBmp(filePath As String, w As Integer, h As Integer)

    Dim fn  As Integer, rs As Long, fs As Long
    Dim i   As Long, j As Long, pad As Long
    Dim b(53) As Byte, px(2) As Byte, z As Byte

    rs = (CLng(w) * 3 + 3) And &HFFFFFFFC
    fs = 54 + rs * CLng(h)

    b(0) = 66: b(1) = 77
    b(2) = CByte(fs And 255)
    b(3) = CByte((fs \ 256) And 255)
    b(4) = CByte((fs \ 65536) And 255)
    b(5) = CByte((fs \ 16777216) And 255)
    b(10) = 54: b(14) = 40
    b(18) = CByte(w And 255): b(19) = CByte((w \ 256) And 255)
    b(22) = CByte(h And 255): b(23) = CByte((h \ 256) And 255)
    b(26) = 1: b(28) = 24

    px(0) = 255: px(1) = 255: px(2) = 255
    z = 0: pad = rs - CLng(w) * 3

    fn = FreeFile
    Open filePath For Binary As #fn
    For i = 0 To 53: Put #fn, , b(i): Next i
    For i = 1 To h
        For j = 1 To w: Put #fn, , px: Next j
        Dim k As Long
        For k = 1 To pad: Put #fn, , z: Next k
    Next i
    Close #fn

End Sub

' ─────────────────────────────────────────────
'  EXCEL'E YAZMA + RESIM EKLEME
' ─────────────────────────────────────────────
Private Sub WriteToExcel(rows As Collection, swApp As Object)

    Dim xlApp  As Object
    Dim xlWb   As Object
    Dim xlWs   As Object
    Dim rowNum As Long
    Dim siraNo As Long
    Dim i      As Long
    Dim r      As CBomRow

    ' ── Excel baglantisi ──
    On Error Resume Next: Set xlApp = GetObject(, "Excel.Application"): On Error GoTo 0
    If xlApp Is Nothing Then Set xlApp = CreateObject("Excel.Application")

    xlApp.Visible = True
    Set xlWb = xlApp.Workbooks.Add
    Set xlWs = xlWb.Sheets(1)
    xlWs.Name = "BOM"

    xlApp.ScreenUpdating = False
    xlApp.Calculation = -4135  ' xlCalculationManual

    ' ── Baslik satiri ──
    Dim headers As Variant
    headers = Array("Resim", "Sira No", "Parca Adi", "Konfigurasyon", _
                    "Malzeme", "Miktar", "Birim Agirlik (kg)", "Net Agirlik (kg)")
    Dim col As Integer
    For col = 0 To 7
        xlWs.Cells(1, col + 1).Value = headers(col)
    Next col

    With xlWs.Range("A1:H1")
        .Interior.Color      = RGB(31, 73, 125)
        .Font.Color          = RGB(255, 255, 255)
        .Font.Bold           = True
        .Font.Size           = 11
        .HorizontalAlignment = -4108  ' xlCenter
        .VerticalAlignment   = -4108  ' xlCenter
        .RowHeight           = 22
    End With

    xlWs.Columns("A").ColumnWidth = 11

    ' ── Veri satirlari (resimler haric) ──
    rowNum = 2
    siraNo = 0

    For i = 1 To rows.Count
        Set r  = rows(i)
        siraNo = siraNo + 1

        xlWs.Rows(rowNum).RowHeight = 50

        With xlWs.Range("A" & rowNum & ":H" & rowNum)
            .HorizontalAlignment = -4108
            .VerticalAlignment   = -4108
        End With

        xlWs.Cells(rowNum, 2).Value = siraNo
        xlWs.Cells(rowNum, 3).Value = r.parcaAdi
        xlWs.Cells(rowNum, 4).Value = r.konfig
        If r.malzeme <> "-" Then xlWs.Cells(rowNum, 5).Value = r.malzeme
        xlWs.Cells(rowNum, 6).Value = r.miktar

        If Not r.modelAcik Then
            xlWs.Cells(rowNum, 7).Value = "?"
            xlWs.Cells(rowNum, 8).Value = "?"
        Else
            xlWs.Cells(rowNum, 7).NumberFormat = "0.00"
            xlWs.Cells(rowNum, 7).Value = Round(r.agirlik, 2)
            xlWs.Cells(rowNum, 8).NumberFormat = "0.00"
            xlWs.Cells(rowNum, 8).Value = Round(Round(r.agirlik, 2) * r.miktar, 2)
        End If

        rowNum = rowNum + 1
    Next i

    ' ── Resimleri ekle (kayma duzeltmeli) ──
    '
    '  Excel .Top degerini ekranda gorunmeyen satirlar icin yanlis
    '  hesaplar ve asagi satirlarda hata birikir. Cozum:
    '   • Her resimden once ScrollRow ile satira git
    '   • DoEvents ile Excel'e repaint firsati ver
    '   • Placement = 1 ile resmi hucreye civile
    '   • Son bir pozisyon teyidi yap
    '
    xlApp.ScreenUpdating = True
    DoEvents: DoEvents

    Dim pic      As Object
    Dim tempPath As String
    Dim cellW    As Double, cellH As Double
    Dim imgSz    As Double
    Dim imgL     As Double, imgT As Double
    Dim shp      As Object

    rowNum = 2
    For i = 1 To rows.Count
        Set r    = rows(i)
        tempPath = Environ("TEMP") & "\sw_bom_" & rowNum & ".bmp"

        ' Preview bitmap al
        Set pic = Nothing
        On Error Resume Next: Set pic = swApp.GetPreviewBitmap(r.dosyaYolu, r.konfig): On Error GoTo 0

        If pic Is Nothing Then
            CreateWhiteBmp tempPath, 40, 40
        Else
            On Error Resume Next: SavePicture pic, tempPath: On Error GoTo 0
            If Dir(tempPath) = "" Then CreateWhiteBmp tempPath, 40, 40
        End If

        If Dir(tempPath) <> "" Then

            ' (1) Satira scroll → .Top dogru hesaplanir
            On Error Resume Next: xlApp.ActiveWindow.ScrollRow = rowNum: On Error GoTo 0
            DoEvents

            ' (2) Hucre olculeri ve resim boyutu
            cellW = xlWs.Cells(rowNum, 1).Width
            cellH = xlWs.Rows(rowNum).RowHeight
            imgSz = cellH - 10
            If (cellW - 10) < imgSz Then imgSz = cellW - 10
            If imgSz < 8 Then imgSz = 8

            imgL = xlWs.Cells(rowNum, 1).Left + (cellW - imgSz) / 2
            imgT = xlWs.Cells(rowNum, 1).Top + (cellH - imgSz) / 2

            ' (3) Resim ekle
            Set shp = Nothing
            On Error Resume Next
            Set shp = xlWs.Shapes.AddPicture(tempPath, False, True, imgL, imgT, imgSz, imgSz)
            On Error GoTo 0

            If Not shp Is Nothing Then
                On Error Resume Next
                shp.Placement = 1        ' xlMoveAndSizeWithCells — hucreye civile
                shp.LockAspectRatio = False

                ' (4) Pozisyon teyidi
                shp.Top    = xlWs.Cells(rowNum, 1).Top + (cellH - imgSz) / 2
                shp.Left   = xlWs.Cells(rowNum, 1).Left + (cellW - imgSz) / 2
                shp.Width  = imgSz
                shp.Height = imgSz
                On Error GoTo 0
                Set shp = Nothing
            End If

            On Error Resume Next: Kill tempPath: On Error GoTo 0
        End If

        rowNum = rowNum + 1
    Next i

    ' Basa don
    On Error Resume Next: xlApp.ActiveWindow.ScrollRow = 1: On Error GoTo 0

    xlApp.ScreenUpdating = False

    ' ── Toplam satiri ──
    With xlWs.Range("A" & rowNum & ":H" & rowNum)
        .Interior.Color = RGB(31, 73, 125)
        .Font.Color     = RGB(255, 255, 255)
        .Font.Bold      = True
    End With

    xlWs.Cells(rowNum, 7).Value               = "TOPLAM"
    xlWs.Cells(rowNum, 7).HorizontalAlignment = -4131  ' xlRight
    xlWs.Cells(rowNum, 8).NumberFormat         = "0.00"
    xlWs.Cells(rowNum, 8).Formula              = "=SUM(H2:H" & rowNum - 1 & ")"
    xlWs.Cells(rowNum, 8).HorizontalAlignment  = -4108  ' xlCenter

    ' ── Kenarliklar ──
    With xlWs.Range("A1:H" & rowNum).Borders
        .LineStyle = 1
        .Weight    = 2
        .Color     = RGB(180, 180, 180)
    End With

    ' ── Sutun genislikleri ──
    xlWs.Columns("B:H").AutoFit
    xlWs.Columns("C").ColumnWidth = 30
    xlWs.Columns("E").ColumnWidth = 20

    xlApp.Calculation    = -4105  ' xlCalculationAutomatic
    xlApp.ScreenUpdating = True

    ' ── Baslik dondur ──
    xlWs.Rows("2:2").Select
    xlApp.ActiveWindow.FreezePanes = True
    xlWs.Cells(1, 1).Select

End Sub

' ══════════════════════════════════════════════════════════════════
' ══  MODULE KODU BITIS                                         ══
' ══════════════════════════════════════════════════════════════════




' ══════════════════════════════════════════════════════════════════
' ══  CLASS KODU BASLANGIC                                      ══
' ══  Insert > Class Module → Name = "CBomRow"                  ══
' ══════════════════════════════════════════════════════════════════

' --- Asagidaki kodu CBomRow isimli Class Module'e yapistirin ---
' --- ONEMLI: Satirlarin basindaki tek tirnak (') isaretlerini silin ---

'Option Explicit
'
'Public parcaAdi  As String
'Public konfig    As String
'Public dosyaYolu As String
'Public miktar    As Long
'Public key       As String
'Public modelAcik As Boolean
'Public agirlik   As Double
'Public malzeme   As String

' ══════════════════════════════════════════════════════════════════
' ══  CLASS KODU BITIS                                          ══
' ══════════════════════════════════════════════════════════════════
